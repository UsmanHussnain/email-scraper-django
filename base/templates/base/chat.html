{% extends 'base/baseIndex.html' %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar with email contacts -->
        <div class="col-lg-3 col-md-4 mb-4 mb-md-0">
            <div class="card h-100 shadow-sm" style="background-color: #f8f9fa;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Contacts
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for email in chat_emails %}
                            <a href="{% url 'chat' contact_email=email %}" 
                               class="list-group-item list-group-item-action {% if email == selected_email %}active{% endif %}" style="background-color: {% if email == selected_email %}#28a745{% else %}#f8f9fa{% endif %};">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-truncate" style="max-width: 80%;">{{ email }}</span>
                                    {% if email == selected_email %}
                                        <span class="badge bg-light text-success rounded-pill">
                                            <i class="fas fa-comment"></i>
                                        </span>
                                    {% endif %}
                                </div>
                            </a>
                        {% empty %}
                            <div class="list-group-item text-muted text-center py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p>No conversations yet</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <button class="btn btn-sm btn-success w-100" data-bs-toggle="modal" data-bs-target="#newChatModal">
                        <i class="fas fa-plus me-1"></i> New Chat
                    </button>
                </div>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="col-lg-9 col-md-8">
            <div class="card h-100 shadow-sm" style="background-color: #f8f9fa;">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    {% if selected_email %}
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>Chat with {{ selected_email }}
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-light text-success border-success me-2" data-bs-toggle="modal" data-bs-target="#emailTemplateModal">
                                <i class="fas fa-file-alt me-1"></i> Templates
                            </button>
                            <a href="{% url 'compose_email' %}?email={{ selected_email }}" class="btn btn-sm btn-warning me-2">
                                <i class="fas fa-paper-plane me-1"></i> Compose Email
                            </a>
                            <button class="btn btn-sm btn-danger delete-chat-btn" data-email="{{ selected_email }}" title="Delete this chat">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    {% else %}
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>Select a contact to start chatting
                        </h5>
                    {% endif %}
                </div>
                
                <!-- Chat messages container -->
                <div class="card-body p-0 position-relative">
                    <div id="chatContainer" class="p-3" style="height: 500px; overflow-y: auto;">
                        {% if selected_email and chat_history %}
                            {% for message in chat_history %}
                                <div class="mb-3 {% if message.is_sent %}text-start{% else %}text-start{% endif %}">
                                    <div class="d-flex {% if message.is_sent %}justify-content-end{% else %}justify-content-start{% endif %}">
                                        <div class="{% if message.is_sent %}bg-success{% else %}bg-light{% endif %} text-{% if message.is_sent %}white{% else %}dark{% endif %} p-3 rounded-3 shadow-sm" 
                                             style="max-width: 70%;">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="fw-bold">
                                                    {% if message.is_sent %}
                                                        You
                                                    {% else %}
                                                        {{ message.sender }}
                                                    {% endif %}
                                                </small>
                                                <small class="ms-2">
                                                    {{ message.timestamp|date:"M j, H:i" }}
                                                </small>
                                            </div>
                                            <!-- Render the message content with inline images -->
                                            <div class="mb-0 message-content">
                                                {% if message.inline_images %}
                                                    {{ message.message|safe }}
                                                {% else %}
                                                    {{ message.message|safe }}
                                                {% endif %}
                                            </div>
                                            <!-- Display attachments -->
                                            {% if message.has_attachment and message.attachment %}
                                                <div class="mt-2">
                                                    <i class="fas fa-file me-1"></i>
                                                    <span>Attachment: {{ message.attachment.name|cut:"/email_attachments/" }}</span>
                                                    <div class="mt-1">
                                                        <a href="{{ message.attachment.url }}" class="btn btn-sm btn-primary me-2" download>
                                                            <i class="fas fa-download me-1"></i> Download
                                                        </a>
                                                        <a href="{{ message.attachment.url }}" target="_blank" class="btn btn-sm btn-info">
                                                            <i class="fas fa-eye me-1"></i> Preview
                                                        </a>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="h-100 d-flex flex-column justify-content-center align-items-center text-muted">
                                {% if not selected_email %}
                                    <i class="fas fa-user-friends fa-3x mb-3"></i>
                                    <h5>Select a contact to view messages</h5>
                                {% else %}
                                    <i class="fas fa-comment-slash fa-3x mb-3"></i>
                                    <h5>No messages yet</h5>
                                    <p>Start the conversation with {{ selected_email }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Message input area -->
                <div class="card-footer bg-light">
                    {% if selected_email %}
                        <form method="POST" id="chatForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="editor-container">
                                <!-- Quill Editor Toolbar -->
                                <div id="editor-toolbar" style="border: 1px solid #ced4da; border-bottom: none; border-radius: 4px 4px 0 0; background: #f8f9fa; padding: 2px 5px; line-height: 1; position: relative;">
                                    <span class="ql-formats">
                                        <select class="ql-font">
                                            <option value="sans-serif" selected>Sans Serif</option>
                                            <option value="serif">Serif</option>
                                            <option value="monospace">Monospace</option>
                                        </select>
                                        <select class="ql-size">
                                            <option value="small">Small</option>
                                            <option value="normal" selected>Normal</option>
                                            <option value="large">Large</option>
                                            <option value="huge">Huge</option>
                                        </select>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-bold"></button>
                                        <button class="ql-italic"></button>
                                        <button class="ql-underline"></button>
                                        <button class="ql-strike"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <select class="ql-color"></select>
                                        <select class="ql-background"></select>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-list" value="ordered"></button>
                                        <button class="ql-list" value="bullet"></button>
                                        <select class="ql-align">
                                            <option value="" selected></option>
                                            <option value="center"></option>
                                            <option value="right"></option>
                                            <option value="justify"></option>
                                        </select>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-link"></button>
                                        <button class="ql-image"></button>
                                        <button class="ql-clean"></button>
                                    </span>
                                </div>
                                <!-- Quill Editor Container -->
                                <div id="editor" style="height: 300px; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 4px 4px;"></div>
                                <!-- Hidden input to store Quill content -->
                                <input type="hidden" name="message" id="messageInput">
                            </div>
                            <!-- Buttons below the editor -->
                            <div class="d-flex justify-content-end mt-2 gap-2">
                                <label for="attachmentInput" class="btn btn-outline-secondary m-0">
                                    <i class="fas fa-paperclip"></i> Attach File
                                </label>
                                <input type="file" id="attachmentInput" name="attachment" style="display: none;" onchange="updateFileName(this)">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted" id="fileName">
                                    {% if form.attachment.value %}Selected: {{ form.attachment.value }}{% else %}No file selected{% endif %}
                                </small>
                                <small class="text-muted">
                                    Messages are sent as emails
                                </small>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Start New Chat</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" action="{% url 'chat' contact_email='new' %}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="newEmail" name="email" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Start Chat</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Email Templates Modal -->
<div class="modal fade" id="emailTemplateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Email Templates</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="list-group" id="templateList">
                            <a href="#" class="list-group-item list-group-item-action active" data-template="template1" style="background-color: #28a745; color: white;">
                                Guest Post Opportunity
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-template="template2">
                                Collaboration Proposal
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-template="template3">
                                Guest Post Partnership
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-template="template4">
                                Boost Your Site
                            </a>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card h-100 shadow-sm" style="background-color: #f8f9fa;">
                            <div class="card-header bg-light">
                                <h6 id="templateTitle" class="mb-0">Template Preview</h6>
                            </div>
                            <div class="card-body">
                                <div id="templatePreview" class="p-2" style="height: 300px; overflow-y: auto;">
                                    <!-- Template content will be loaded here -->
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <button id="useTemplateBtn" class="btn btn-sm btn-success">
                                    <i class="fas fa-check me-1"></i> Use This Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Delete -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the chat with <strong id="deleteEmail"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<!-- Include Quill.js and jQuery -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const toastLiveExample = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastLiveExample);
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        // Initialize Quill editor
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: '#editor-toolbar'
            },
            placeholder: 'Type your message here...'
        });

        // Handle dropdown visibility (especially for color and background pickers)
        function handleDropdownVisibility() {
            // Hide all dropdowns when clicking anywhere on the document
            $(document).on('click', function(e) {
                // If the click is not on a picker label or inside a picker, hide all dropdowns
                if (!$(e.target).closest('.ql-picker-label').length && !$(e.target).closest('.ql-picker-options').length) {
                    $('.ql-picker-options').removeClass('ql-expanded').hide();
                    $('.ql-picker-label').removeClass('ql-expanded');
                }
            });

            // Show/hide dropdowns on click
            $('.ql-picker-label').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const $picker = $(this).closest('.ql-picker');
                const $options = $picker.find('.ql-picker-options');

                // Toggle the current dropdown
                if ($options.is(':visible')) {
                    $options.removeClass('ql-expanded').hide();
                    $(this).removeClass('ql-expanded');
                } else {
                    // Hide all other dropdowns
                    $('.ql-picker-options').removeClass('ql-expanded').hide();
                    $('.ql-picker-label').removeClass('ql-expanded');
                    // Show the current dropdown
                    $options.addClass('ql-expanded').show();
                    $(this).addClass('ql-expanded');
                }
            });

            // Hide dropdown after selecting an option
            $('.ql-picker-item').on('click', function() {
                const $options = $(this).closest('.ql-picker-options');
                $options.removeClass('ql-expanded').hide();
                $options.siblings('.ql-picker-label').removeClass('ql-expanded');
            });
        }

        // Call the function to handle dropdown visibility
        handleDropdownVisibility();

        // Template data
        const templates = {
            template1: {
                title: "Guest Post Opportunity",
                content: `<p>Hello,</p><p>I hope this email finds you well! My name is [Your Name], and I'm reaching out to discuss a potential guest post opportunity for your website. We specialize in creating high-quality, engaging content that aligns with your audience's interests.</p><p>I'd love to contribute a well-researched article that provides value to your readers. Please let me know if you're open to this idea, and I can share some topic suggestions.</p><p>Looking forward to hearing from you!</p><p>Regards,</p><p>{{ user.first_name|default:user.username }}</p>`
            },
            template2: {
                title: "Collaboration Proposal: Guest Blog Post",
                content: `<p>Hi there,</p><p>I'm [Your Name], a content creator passionate about [your niche]. I've been following your website and love the content you share. I'd like to propose a guest blog post that complements your site's theme and adds value for your readers.</p><p>If you're interested, I can send over a few topic ideas or work with any guidelines you provide.</p><p>Let's connect and discuss further!</p><p>Regards,</p><p>{{ user.first_name|default:user.username }}</p>`
            },
            template3: {
                title: "Interested in a Guest Post Partnership?",
                content: `<p>Dear [Website Owner],</p><p>Greetings! I'm [Your Name], and I specialize in crafting informative and engaging content. I believe a guest post on your website could be a great way to share valuable insights with your audience.</p><p>I'm happy to write on a topic that fits your site's focus. Please let me know your guest posting guidelines or any preferred topics.</p><p>Excited to collaborate!</p><p>Regards,</p><p>{{ user.first_name|default:user.username }}</p>`
            },
            template4: {
                title: "Let's Boost Your Site with a Guest Post",
                content: `<p>Hello,</p><p>My name is [Your Name], and I'm a writer with a passion for creating content that resonates with readers. I'd love to contribute a guest post to your website, offering fresh perspectives and actionable insights.</p><p>If this sounds interesting, I can provide topic ideas or follow your editorial guidelines.</p><p>Looking forward to your response!</p><p>Regards,</p><p>{{ user.first_name|default:user.username }}</p>`
            }
        };
        
        // Show Django messages as toasts
        {% for message in messages %}
            showToast("{{ message }}", "{{ message.tags }}");
        {% endfor %}
        
        // Auto-scroll chat to bottom on page load
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Handle template selection
        $('[data-template]').click(function(e) {
            e.preventDefault();
            const templateId = $(this).data('template');
            const template = templates[templateId];
            
            // Update active state
            $('[data-template]').removeClass('active');
            $(this).addClass('active');
            
            // Update preview
            $('#templateTitle').text(template.title);
            $('#templatePreview').html(template.content);
            
            // Update styles for active template
            $('[data-template]').css({'background-color': '', 'color': ''});
            $(this).css({'background-color': '#28a745', 'color': 'white'});
        });
        
        // Initialize first template on modal show
        $('#emailTemplateModal').on('show.bs.modal', function() {
            if ($('[data-template]').length > 0) {
                const firstTemplate = $('[data-template]').first().data('template');
                $('#templateTitle').text(templates[firstTemplate].title);
                $('#templatePreview').html(templates[firstTemplate].content);
                $('[data-template]').first().addClass('active').css({'background-color': '#28a745', 'color': 'white'});
            }
        });
        
        // Use template button
        $('#useTemplateBtn').click(function() {
            const activeTemplate = $('[data-template].active').data('template');
            if (activeTemplate && templates[activeTemplate]) {
                quill.root.innerHTML = templates[activeTemplate].content;
                $('#emailTemplateModal').modal('hide');
                quill.focus();
                showToast('Template applied successfully!', 'success');
            }
        });
        
        // Update file name display when a file is selected
        window.updateFileName = function(input) {
            const fileName = input.files.length > 0 ? input.files[0].name : 'No file selected';
            $('#fileName').text(`Selected: ${fileName}`);
        };
        
        // Form submission with Quill content using AJAX
        $('#chatForm').submit(function(e) {
            e.preventDefault(); // Prevent default form submission

            // Get Quill content as HTML
            const message = quill.root.innerHTML.trim();
            const attachment = $('#attachmentInput')[0].files.length > 0;

            if (!message || message === '<p><br></p>') {
                if (!attachment) {
                    showToast('Please enter a message or attach a file.', 'warning');
                    return false;
                }
            }

            // Set the Quill content to the hidden input
            $('#messageInput').val(message);

            // Prepare form data for AJAX
            const formData = new FormData(this);
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();

            // Show sending indicator
            submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Sending...').prop('disabled', true);

            // Send AJAX request
            $.ajax({
                url: $(this).attr('action') || window.location.href, // Use form action or current URL
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        showToast(response.message, 'success');
                        // Redirect to the chat page to show updated messages
                        setTimeout(function() {
                            window.location.href = response.redirect_url || window.location.href;
                        }, 1000);
                    } else {
                        showToast(response.message, 'danger');
                        submitBtn.html(originalText).prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    showToast('An error occurred while sending the message.', 'danger');
                    submitBtn.html(originalText).prop('disabled', false);
                },
                complete: function() {
                    // Reset the form after submission
                    quill.root.innerHTML = '';
                    $('#attachmentInput').val('');
                    $('#fileName').text('No file selected');
                }
            });
        });
        
        // Auto-refresh chat every 30 seconds to check for new emails
        setInterval(function() {
            // Only refresh if user is not focused on the editor
            if (!quill.hasFocus()) {
                checkForNewMessages();
            }
        }, 30000);
        
        // Delete chat functionality
        $('.delete-chat-btn').click(function() {
            const email = $(this).data('email');
            $('#deleteEmail').text(email);
            deleteConfirmModal.show();
        });

        $('#confirmDeleteBtn').click(function() {
            const email = $('#deleteEmail').text();
            $.ajax({
                url: `{% url 'delete_chat' contact_email='PLACEHOLDER' %}`.replace('PLACEHOLDER', email),
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                beforeSend: function() {
                    $('#confirmDeleteBtn').html('<i class="fas fa-spinner fa-spin"></i> Deleting...').prop('disabled', true);
                },
                success: function(response) {
                    if (response.status === 'success') {
                        showToast(response.message, 'success');
                        setTimeout(function() {
                            window.location.href = '/chat/';  // Redirect to chat list
                        }, 2000);
                    } else {
                        showToast(response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('An error occurred while deleting the chat.', 'danger');
                },
                complete: function() {
                    deleteConfirmModal.hide();
                    $('#confirmDeleteBtn').html('Delete').prop('disabled', false);
                }
            });
        });

        function checkForNewMessages() {
            // Simple check - reload the page to fetch new emails
            const currentMessageCount = $('.mb-3').length;
            $.get(window.location.href, function(data) {
                const newDoc = $(data);
                const newMessageCount = newDoc.find('.mb-3').length;
                if (newMessageCount > currentMessageCount) {
                    location.reload();
                }
            });
        }
        
        function showToast(message, type) {
            const toastBody = $('.toast-body');
            const toastHeader = $('.toast-header');
            
            // Set appropriate colors based on message type
            toastBody.removeClass().addClass('toast-body');
            toastHeader.removeClass().addClass('toast-header');
            
            switch(type) {
                case 'success':
                    toastBody.addClass('text-success');
                    toastHeader.addClass('bg-success text-white');
                    break;
                case 'error':
                case 'danger':
                    toastBody.addClass('text-danger');
                    toastHeader.addClass('bg-danger text-white');
                    break;
                case 'warning':
                    toastBody.addClass('text-warning');
                    toastHeader.addClass('bg-warning');
                    break;
                default:
                    toastBody.addClass('text-info');
                    toastHeader.addClass('bg-info text-white');
            }
            
            toastBody.text(message);
            toast.show();
        }
    });
</script>

<style>
    /* Custom styles for chat interface */
    .list-group-item {
        transition: background-color 0.3s ease;
    }
    
    .list-group-item:hover {
        background-color: #e9ecef !important;
    }
    
    .list-group-item.active {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
    }
    
    #chatContainer {
        background-color: #f8f9fa;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e9ecef' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    [data-bs-theme="dark"] #chatContainer {
        background-color: #2c3e50;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231a1a2e' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    /* Custom scrollbar */
    #chatContainer::-webkit-scrollbar {
        width: 8px;
    }
    
    #chatContainer::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    #chatContainer::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    #chatContainer::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    [data-bs-theme="dark"] #chatContainer::-webkit-scrollbar-track {
        background: #2c3e50;
    }
    
    [data-bs-theme="dark"] #chatContainer::-webkit-scrollbar-thumb {
        background: #6c757d;
    }
    
    /* Message bubbles */
    .bg-light {
        background-color: #e9ecef !important;
        border: 1px solid #dee2e6;
    }
    
    [data-bs-theme="dark"] .bg-light {
        background-color: #343a40 !important;
        color: #f8f9fa;
        border: 1px solid #495057;
    }
    
    /* Card enhancements */
    .card {
        border: none;
        border-radius: 10px;
        transition: transform 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    /* Message animation */
    .mb-3 {
        animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .col-lg-3, .col-lg-9 {
            padding-left: 0;
            padding-right: 0;
        }
        
        #chatContainer {
            height: 300px !important;
        }
        
        .modal-dialog.modal-lg {
            max-width: 95%;
        }
    }
    
    /* Loading state */
    .btn:disabled {
        opacity: 0.7;
    }
    
    /* Template preview styling */
    #templatePreview {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Style for Quill editor */
    .editor-container {
        margin-bottom: 10px;
        position: relative; /* Ensure dropdowns position correctly */
    }

    #editor-toolbar {
        height: 30px; /* Compact toolbar height */
        position: relative;
        z-index: 1000; /* Ensure toolbar stays above editor */
    }

    #editor {
        background: white;
        height: 300px; /* Increased height for better appearance */
        line-height: 1.5;
        overflow-y: auto;
        position: relative;
        z-index: 1; /* Lower than toolbar and dropdowns */
    }

    [data-bs-theme="dark"] #editor {
        background: #343a40;
        color: #f8f9fa;
    }

    /* Ensure images in chat messages are responsive */
    .message-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 5px 0;
    }

    /* Buttons styling */
    .gap-2 {
        gap: 10px;
    }

    /* Fix Quill dropdown visibility */
    .ql-picker-options {
        position: absolute !important;
        z-index: 1001 !important; /* Above toolbar and editor */
        background-color: #fff !important; /* Visible background */
        border: 1px solid #ced4da !important;
        border-radius: 4px !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
        min-width: 120px !important;
        top: 100% !important; /* Position below the toolbar */
        margin-top: 2px !important;
        display: none; /* Initially hidden */
    }

    .ql-picker-options.ql-expanded {
        display: block !important; /* Show when expanded */
    }

    /* Ensure dropdown items are visible and clickable */
    .ql-picker-item {
        color: #333 !important;
        padding: 5px 10px !important;
        cursor: pointer !important;
    }

    .ql-picker-item:hover {
        background-color: #f0f0f0 !important;
    }

    /* Dark theme adjustments for dropdowns */
    [data-bs-theme="dark"] .ql-picker-options {
        background-color: #444 !important;
        border-color: #666 !important;
    }

    [data-bs-theme="dark"] .ql-picker-item {
        color: #f8f9fa !important;
    }

    [data-bs-theme="dark"] .ql-picker-item:hover {
        background-color: #555 !important;
    }

    /* Fix color and background picker */
    .ql-snow .ql-picker.ql-color .ql-picker-options,
    .ql-snow .ql-picker.ql-background .ql-picker-options {
        padding: 5px !important;
        display: none; /* Initially hidden */
        flex-wrap: wrap !important;
        width: 200px !important;
    }

    .ql-snow .ql-picker.ql-color .ql-picker-options.ql-expanded,
    .ql-snow .ql-picker.ql-background .ql-picker-options.ql-expanded {
        display: flex !important; /* Show when expanded */
    }

    .ql-snow .ql-picker.ql-color .ql-picker-item,
    .ql-snow .ql-picker.ql-background .ql-picker-item {
        width: 20px !important;
        height: 20px !important;
        margin: 2px !important;
        border-radius: 3px !important;
    }

    /* Ensure toolbar buttons and dropdowns are clickable */
    .ql-snow .ql-toolbar button,
    .ql-snow .ql-toolbar .ql-picker-label {
        cursor: pointer !important;
    }

    /* Fix alignment picker visibility */
    .ql-snow .ql-picker.ql-align .ql-picker-item {
        color: #000000 !important; /* Text color for alignment options */
        position: relative !important;
        padding-left: 25px !important; /* Space for the icon */
    }

    .ql-snow .ql-picker.ql-align .ql-picker-item:before {
        content: attr(data-value) !important; /* Use the value as text for now */
        position: absolute !important;
        left: 5px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        font-family: 'Arial', sans-serif !important; /* Fallback font */
    }

    .ql-snow .ql-align .ql-picker-item[data-value=""]::before {
        content: "Left" !important;
    }

    .ql-snow .ql-align .ql-picker-item[data-value="center"]::before {
        content: "Center" !important;
    }

    .ql-snow .ql-align .ql-picker-item[data-value="right"]::before {
        content: "Right" !important;
    }

    .ql-snow .ql-align .ql-picker-item[data-value="justify"]::before {
        content: "Justify" !important;
    }

    [data-bs-theme="dark"] .ql-snow .ql-picker.ql-align .ql-picker-item {
        color: #f8f9fa !important; /* Text color in dark theme */
    }

    [data-bs-theme="dark"] .ql-snow .ql-picker.ql-align .ql-picker-item:before {
        color: #f8f9fa !important; /* Icon color in dark theme */
    }
</style>
{% endblock %}